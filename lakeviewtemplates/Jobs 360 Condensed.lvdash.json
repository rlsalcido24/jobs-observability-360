{"datasets":[{"name":"29e67d9d","displayName":"jobmem","query":"with clusterutil as (SELECT * from \n\tsystem.compute.node_timeline\nWHERE\n\tstart_time >= date_add(now(), -:lookbackwindow::int)\n),\n\njobutil as (\n    select * from system.billing.usage\n    where usage_date >= date_add(now(), -:lookbackwindow::int)\n    and sku_name ilike '%jobs%'\n    and sku_name not ilike '%jobs_serverless%'\n),\n\njunto as (\nselect jobutil.usage_metadata.job_id as jobid, avg(jobutil.usage_quantity) as dbus,\navg(cpu_user_percent + cpu_system_percent) as `Avg CPU Utilization`, \nmax(cpu_user_percent + cpu_system_percent) as `Peak CPU Utilization`, \n\tavg(cpu_wait_percent) as `Avg CPU Disk Wait`,\n\tmax(cpu_wait_percent) as `Max CPU Disk Wait`,\n\tavg(mem_used_percent) as `Avg Memory Utilization`, \n\tmax(mem_used_percent) as `Max Memory Utilization`\nfrom clusterutil join jobutil\non clusterutil.cluster_id = jobutil.usage_metadata.cluster_id\ngroup by 1)\n\nselect *\nfrom junto\norder by `Avg Memory Utilization` desc\nlimit 10","parameters":[{"displayName":"lookbackwindow","keyword":"lookbackwindow","dataType":"DECIMAL","defaultSelection":{"values":{"dataType":"DECIMAL","values":[{"value":"30"}]}}}]},{"name":"0258c5f6","displayName":"spendbytag","query":"with tagraw as (\n    select explode(custom_tags) as (llave, val), usage_quantity as rawdbus  \n    from system.billing.usage),\n\ntagspend as ( select val as tagbucket, sum(rawdbus) as dbus\nfrom tagraw \ngroup by 1),\n\ncatchall as (select 'catchall' as tagbucket , sum(usage_quantity) as dbus\nfrom system.billing.usage\nwhere usage_date >= date_add(now(), -:lookbackwindow::int)\nand cardinality(custom_tags) = 0)\n\nselect * from tagspend\nunion all\nselect * from catchall\norder by dbus desc\nlimit 20","parameters":[{"displayName":"lookbackwindow","keyword":"lookbackwindow","dataType":"DECIMAL","defaultSelection":{"values":{"dataType":"DECIMAL","values":[{"value":"30"}]}}}]},{"name":"b6168d08","displayName":"jobalert","query":"with clusterutil as (SELECT * from \n\tsystem.compute.clusters\n),\n\njobutil as (\n    select * from system.billing.usage\n    where usage_date >= date_add(now(), -:lookbackwindow::int)\n    and sku_name ilike '%jobs%'\n    and sku_name not ilike '%jobs_serverless%'\n)\n\nselect cu.workspace_id, ju.usage_metadata.job_id, any_value(min_autoscale_workers), any_value(max_autoscale_workers), any_value(auto_termination_minutes) from \nclusterutil cu join jobutil ju\non cu.cluster_id = ju.usage_metadata.cluster_id\nwhere min_autoscale_workers is NULL OR max_autoscale_workers is NULL or auto_termination_minutes is NULL\ngroup by 1, 2","parameters":[{"displayName":"lookbackwindow","keyword":"lookbackwindow","dataType":"DECIMAL","defaultSelection":{"values":{"dataType":"DECIMAL","values":[{"value":"30"}]}}}]},{"name":"6ef31856","displayName":"jobdbr","query":"with clusterutil as (SELECT *  from \n\tsystem.compute.clusters\n),\n\njobutil as (\n    select * from system.billing.usage\n    where usage_date >= date_add(now(), -:lookbackwindow::int)\n    and sku_name ilike '%jobs%'\n    and sku_name not ilike '%jobs_serverless%'\n)\n\nselect cu.workspace_id, ju.usage_metadata.job_id, any_value(dbr_Version) from \nclusterutil cu join jobutil ju\non cu.cluster_id = ju.usage_metadata.cluster_id\nwhere left(dbr_version, 1) <> '1'\ngroup by 1, 2","parameters":[{"displayName":"lookbackwindow","keyword":"lookbackwindow","dataType":"DECIMAL","defaultSelection":{"values":{"dataType":"DECIMAL","values":[{"value":"30"}]}}}]},{"name":"6e654e3c","displayName":"joboptim","query":"with clusterutil as (SELECT * from \n\tsystem.compute.node_timeline\nWHERE\n\tstart_time >= date_add(now(), -:lookbackwindow::int)\n),\n\njobutil as (\n    select * from system.billing.usage\n    where usage_date >= date_add(now(), -:lookbackwindow::int)\n    and sku_name ilike '%jobs%'\n    and sku_name not ilike '%jobs_serverless%'\n),\n\njunto as (\nselect jobutil.usage_metadata.job_id as jobid, avg(jobutil.usage_quantity) as dbus,\navg(cpu_user_percent + cpu_system_percent) as `Avg CPU Utilization`, \nmax(cpu_user_percent + cpu_system_percent) as `Peak CPU Utilization`, \n\tavg(cpu_wait_percent) as `Avg CPU Disk Wait`,\n\tmax(cpu_wait_percent) as `Max CPU Disk Wait`,\n\tavg(mem_used_percent) as `Avg Memory Utilization`, \n\tmax(mem_used_percent) as `Max Memory Utilization`\nfrom clusterutil join jobutil\non clusterutil.cluster_id = jobutil.usage_metadata.cluster_id\ngroup by 1)\n\nselect *, (dbus * (1 - (`Avg CPU Utilization` / 100))) * .15 as maxsavings\nfrom junto\norder by maxsavings desc\nlimit 10\n","parameters":[{"displayName":"lookbackwindow","keyword":"lookbackwindow","dataType":"DECIMAL","defaultSelection":{"values":{"dataType":"DECIMAL","values":[{"value":"30"}]}}}]},{"name":"94dc6598","displayName":"jobutil","query":"with clusterutil as (SELECT * from \n\tsystem.compute.node_timeline\nWHERE\n\tstart_time >= date_add(now(), -:lookbackwindow::int)\n),\n\njobutil as (\n    select * from system.billing.usage\n    where usage_date >= date_add(now(), -:lookbackwindow::int)\n    and sku_name ilike '%jobs%'\n    and sku_name not ilike '%jobs_serverless%'\n),\n\njunto as (\nselect jobutil.usage_metadata.job_id as jobid, avg(jobutil.usage_quantity) as dbus,\navg(cpu_user_percent + cpu_system_percent) as `Avg CPU Utilization`, \nmax(cpu_user_percent + cpu_system_percent) as `Peak CPU Utilization`, \n\tavg(cpu_wait_percent) as `Avg CPU Disk Wait`,\n\tmax(cpu_wait_percent) as `Max CPU Disk Wait`,\n\tavg(mem_used_percent) as `Avg Memory Utilization`, \n\tmax(mem_used_percent) as `Max Memory Utilization`\nfrom clusterutil join jobutil\non clusterutil.cluster_id = jobutil.usage_metadata.cluster_id\ngroup by 1)\n\nselect *, (dbus * (1 - (`Avg CPU Utilization` / 100))) * .15 as maxsavings\nfrom junto\norder by maxsavings desc\nlimit 10","parameters":[{"displayName":"lookbackwindow","keyword":"lookbackwindow","dataType":"DECIMAL","defaultSelection":{"values":{"dataType":"DECIMAL","values":[{"value":"30"}]}}}]}],"pages":[{"name":"a0bfbb73","displayName":"New Page","layout":[{"widget":{"name":"129a732a","queries":[{"name":"main_query","query":{"datasetName":"6e654e3c","fields":[{"name":"jobid","expression":"`jobid`"},{"name":"sum(maxsavings)","expression":"SUM(`maxsavings`)"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"bar","encodings":{"y":{"fieldName":"sum(maxsavings)","scale":{"type":"quantitative"},"axis":{"title":"savings"},"displayName":"savings"},"color":{"fieldName":"jobid","scale":{"type":"categorical"},"displayName":"jobid"}},"format":{"timeFormat":{"formatType":"moment","format":"DD/MM/YYYY HH:mm"}},"frame":{"title":"Top 10 Jobs by Potential Savings","showTitle":true},"mark":{"layout":"stack"}}},"position":{"x":0,"y":2,"width":3,"height":8}},{"widget":{"name":"3a401330","queries":[{"name":"main_query","query":{"datasetName":"b6168d08","fields":[{"name":"job_id","expression":"`job_id`"},{"name":"workspace_id","expression":"`workspace_id`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"workspace_id","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":100000,"title":"workspace_id","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"workspace_id"},{"fieldName":"job_id","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":100001,"title":"job_id","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"job_id"}]},"invisibleColumns":[{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"any_value(min_autoscale_workers)","type":"integer","displayAs":"number","order":100002,"title":"any_value(min_autoscale_workers)","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false},{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"any_value(max_autoscale_workers)","type":"integer","displayAs":"number","order":100003,"title":"any_value(max_autoscale_workers)","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false},{"numberFormat":"0","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"name":"any_value(auto_termination_minutes)","type":"integer","displayAs":"number","order":100004,"title":"any_value(auto_termination_minutes)","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false}],"allowHTMLByDefault":false,"itemsPerPage":25,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"title":"Jobs without scaling or auto-terminate","showTitle":true}}},"position":{"x":0,"y":18,"width":3,"height":14}},{"widget":{"name":"846f1b8b","queries":[{"name":"main_query","query":{"datasetName":"0258c5f6","fields":[{"name":"sum(dbus)","expression":"SUM(`dbus`)"},{"name":"tagbucket","expression":"`tagbucket`"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"pie","encodings":{"angle":{"fieldName":"sum(dbus)","scale":{"type":"quantitative"},"displayName":"dbus"},"color":{"fieldName":"tagbucket","scale":{"type":"categorical"},"displayName":"tagbucket"},"label":{"show":true}},"mark":{"layout":"layer"},"format":{"timeFormat":{"formatType":"moment","format":"DD/MM/YY HH:mm:ss.SSS"}},"frame":{"title":"DBUs by Tag","showTitle":true}}},"position":{"x":0,"y":10,"width":3,"height":8}},{"widget":{"name":"6da8f2c0","queries":[{"name":"main_query","query":{"datasetName":"6ef31856","fields":[{"name":"any_value(dbr_Version)","expression":"`any_value(dbr_Version)`"},{"name":"job_id","expression":"`job_id`"},{"name":"workspace_id","expression":"`workspace_id`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"workspace_id","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":100000,"title":"workspace_id","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"workspace_id"},{"fieldName":"job_id","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":100001,"title":"job_id","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"job_id"},{"fieldName":"any_value(dbr_Version)","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":100002,"title":"any_value(dbr_Version)","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"any_value(dbr_Version)"}]},"invisibleColumns":[],"allowHTMLByDefault":false,"itemsPerPage":25,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"title":"Jobs on <10 DBR","showTitle":true}}},"position":{"x":3,"y":18,"width":3,"height":14}},{"widget":{"name":"db587b4d","textbox_spec":"This is a v1 of a dash to surface relevant items to teams looking to optimize/tune their databricks env. The first three charts surface inefficient jobs with the most potential for savings based on CPU utilization and memory utilization. There is also a pie chart for spend by tag (any untagged workload is defined as catchall) and tables that return jobs that either don't have scaling enabled or don't have auto termination enabled. Last there is a table to surface jobs on low DBRs.\n\n"},"position":{"x":0,"y":0,"width":6,"height":2}},{"widget":{"name":"53b8fdd9","queries":[{"name":"main_query","query":{"datasetName":"94dc6598","fields":[{"name":"jobid","expression":"`jobid`"},{"name":"sum(Avg CPU Utilization)","expression":"SUM(`Avg CPU Utilization`)"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"bar","encodings":{"x":{"fieldName":"jobid","scale":{"type":"categorical","sort":{"by":"y-reversed"}},"displayName":"jobid"},"y":{"fieldName":"sum(Avg CPU Utilization)","scale":{"type":"quantitative"},"axis":{"title":"Avg CPU Util"},"displayName":"Avg CPU Util"},"label":{"show":false}},"format":{"timeFormat":{"formatType":"moment","format":"DD/MM/YY HH:mm:ss.SSS"}},"frame":{"title":"Top 10 Lowest CPU Util Jobs","showTitle":true},"mark":{"layout":"group"}}},"position":{"x":3,"y":2,"width":3,"height":8}},{"widget":{"name":"0efbc19a","queries":[{"name":"main_query","query":{"datasetName":"29e67d9d","fields":[{"name":"jobid","expression":"`jobid`"},{"name":"sum(Avg Memory Utilization)","expression":"SUM(`Avg Memory Utilization`)"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"bar","encodings":{"x":{"fieldName":"jobid","scale":{"type":"categorical","sort":{"by":"y-reversed"}},"displayName":"jobid"},"y":{"fieldName":"sum(Avg Memory Utilization)","scale":{"type":"quantitative"},"displayName":"Sum of Avg Memory Utilization"}},"format":{"timeFormat":{"formatType":"moment","format":"DD/MM/YY HH:mm:ss.SSS"}},"frame":{"title":"Top 10 Jobs High Mem Util","showTitle":true},"mark":{"layout":"group"}}},"position":{"x":3,"y":10,"width":3,"height":8}}]}]}